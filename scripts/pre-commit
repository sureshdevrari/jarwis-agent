#!/bin/bash
# Pre-commit hook for Jarwis
# Automatically regenerates frontend contracts when Python contracts change
#
# Installation:
#   Copy this file to .git/hooks/pre-commit
#   Make executable: chmod +x .git/hooks/pre-commit

echo "üîç Pre-commit: Checking for contract changes..."

# Get list of staged files
CHANGED_FILES=$(git diff --cached --name-only)

# Check if contract files were modified
CONTRACT_CHANGED=false
if echo "$CHANGED_FILES" | grep -qE "(shared/api_endpoints\.py|shared/constants\.py)"; then
    CONTRACT_CHANGED=true
fi

if [ "$CONTRACT_CHANGED" = true ]; then
    echo "üìù Contract files changed, regenerating frontend types..."
    
    # Run generator
    python shared/generate_frontend_types.py
    
    # Check if generation was successful
    if [ $? -eq 0 ]; then
        echo "‚úÖ Frontend types generated successfully"
        
        # Check if generated files changed
        if git diff --quiet jarwisfrontend/src/config/*.generated.js 2>/dev/null; then
            echo "‚ÑπÔ∏è  No changes to generated files"
        else
            # Add generated files to commit
            git add jarwisfrontend/src/config/*.generated.js
            echo "‚úÖ Added generated files to commit"
        fi
    else
        echo "‚ùå Failed to generate frontend types"
        echo "Please fix the error and try again."
        exit 1
    fi
else
    echo "‚è≠Ô∏è  No contract changes detected"
fi

# Check if architecture-related files were modified
ARCH_CHANGED=false
if echo "$CHANGED_FILES" | grep -qE "(api/routes/|attacks/|core/__init__|attacks/__init__)"; then
    ARCH_CHANGED=true
fi

if [ "$ARCH_CHANGED" = true ]; then
    echo "üìê Architecture files changed, regenerating documentation..."
    
    # Run architecture docs generator
    python scripts/generate_architecture_docs.py
    
    # Check if generation was successful
    if [ $? -eq 0 ]; then
        echo "‚úÖ Architecture docs generated successfully"
        
        # Check if generated files changed
        if git diff --quiet docs/generated/*.md 2>/dev/null; then
            echo "‚ÑπÔ∏è  No changes to generated docs"
        else
            # Add generated files to commit
            git add docs/generated/*.md
            echo "‚úÖ Added generated docs to commit"
        fi
    else
        echo "‚ö†Ô∏è  Failed to generate architecture docs (non-blocking)"
    fi
else
    echo "‚è≠Ô∏è  No architecture changes detected"
fi

# Optional: Run quick validation
if command -v python &> /dev/null; then
    echo "üîç Running quick validation..."
    
    # Check for Python syntax errors in changed files
    PY_FILES=$(echo "$CHANGED_FILES" | grep '\.py$' || true)
    
    if [ -n "$PY_FILES" ]; then
        for file in $PY_FILES; do
            if [ -f "$file" ]; then
                python -m py_compile "$file" 2>/dev/null
                if [ $? -ne 0 ]; then
                    echo "‚ùå Syntax error in $file"
                    exit 1
                fi
            fi
        done
        echo "‚úÖ Python syntax check passed"
    fi
fi

echo "‚úÖ Pre-commit checks completed"
exit 0
