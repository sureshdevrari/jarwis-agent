# ===========================================================================
# Jarwis Agent - CI/CD Build Pipeline
# ===========================================================================
#
# Builds and releases native installers for Windows, macOS, and Linux.
# 
# Triggers:
#   - Push to 'release/*' branches
#   - Manual dispatch
#   - Tags matching 'v*'
#
# Required Secrets:
#   Windows (Azure Trusted Signing):
#     - AZURE_CLIENT_ID
#     - AZURE_CLIENT_SECRET
#     - AZURE_TENANT_ID
#     - AZURE_SIGNING_ACCOUNT
#     - AZURE_SIGNING_PROFILE
#
#   macOS (Apple Developer):
#     - APPLE_CERTIFICATE_P12
#     - APPLE_CERTIFICATE_PASSWORD
#     - APPLE_INSTALLER_CERTIFICATE_P12
#     - APPLE_INSTALLER_CERTIFICATE_PASSWORD
#     - APPLE_TEAM_ID
#     - APPLE_ID
#     - APPLE_APP_PASSWORD
#
#   Release:
#     - GITHUB_TOKEN (automatic)
#
# ===========================================================================

name: Build Agent Installers

on:
  push:
    branches:
      - release/*
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 2.1.0)'
        required: false
        default: '2.1.0'
      sign:
        description: 'Sign the installers'
        type: boolean
        required: false
        default: true

env:
  PYTHON_VERSION: '3.11'
  VERSION: ${{ github.event.inputs.version || '2.1.0' }}

jobs:
  # ===========================================================================
  # Pre-flight Check
  # ===========================================================================
  preflight:
    name: Pre-flight Validation
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Run pre-flight checks
        run: |
          pip install pillow
          python installer/preflight_check.py --platform all
        continue-on-error: true

  # ===========================================================================
  # Windows Build
  # ===========================================================================
  build-windows:
    needs: preflight
    name: Build Windows Installer
    runs-on: windows-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller PyQt6 Pillow
          pip install -r installer/requirements-agent.txt
          
      - name: Generate branding assets
        run: |
          # Run from project root so paths resolve correctly
          python installer/assets/create_icons.py
        continue-on-error: true
          
      - name: Build main executable with PyInstaller
        run: |
          pyinstaller installer/jarwis-agent.spec `
            --distpath dist/jarwis-agent `
            --workpath dist/build `
            --clean --noconfirm
          
          # Also copy to windows folder for MSI build
          New-Item -ItemType Directory -Force -Path dist/windows
          Copy-Item dist/jarwis-agent/* dist/windows/ -Recurse -Force
            
      - name: Build GUI Setup Wizard
        run: |
          # Build the PyQt6 GUI installer wizard
          pyinstaller installer/jarwis-setup-gui.spec `
            --distpath dist/windows `
            --workpath dist/windows/build `
            --clean --noconfirm
            
      - name: Build System Tray App
        run: |
          pyinstaller installer/jarwis-tray.spec `
            --distpath dist/windows `
            --workpath dist/windows/build `
            --clean --noconfirm
            
      - name: Build Config Tool
        run: |
          pyinstaller installer/jarwis-config.spec `
            --distpath dist/windows `
            --workpath dist/windows/build `
            --clean --noconfirm
            
      - name: Install Azure CLI
        if: github.event.inputs.sign == 'true' || github.event_name == 'push'
        run: |
          Invoke-WebRequest -Uri https://aka.ms/installazurecliwindows -OutFile AzureCLI.msi
          Start-Process msiexec.exe -Wait -ArgumentList '/I AzureCLI.msi /quiet'
          
      - name: Sign executables with Azure Trusted Signing
        if: github.event.inputs.sign == 'true' || github.event_name == 'push'
        continue-on-error: true  # Allow build to continue if signing fails
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          az login --service-principal `
            -u $env:AZURE_CLIENT_ID `
            -p $env:AZURE_CLIENT_SECRET `
            --tenant $env:AZURE_TENANT_ID
            
          # Sign all executables
          az trustedsigning sign `
            --account-name ${{ secrets.AZURE_SIGNING_ACCOUNT }} `
            --certificate-profile ${{ secrets.AZURE_SIGNING_PROFILE }} `
            --endpoint https://eus.codesigning.azure.net `
            --files "dist/windows/jarwis-agent.exe" "dist/windows/jarwis-tray.exe" "dist/windows/jarwis-config.exe" `
            --description "Jarwis Security Agent" `
            --timestamp-rfc3161 http://timestamp.acs.microsoft.com `
            --timestamp-digest SHA256
            
      - name: Install WiX Toolset
        run: |
          dotnet tool install --global wix
          
      - name: Install Inno Setup
        run: |
          choco install innosetup -y
          
      - name: Build MSI installer (Enterprise)
        run: |
          cd dist/windows
          
          # Copy required files for WiX
          Copy-Item "../../config/config.yaml" .
          # Create LICENSE.txt from LICENSE.rtf content
          Get-Content "../../installer/LICENSE.rtf" | Out-File -Encoding utf8 LICENSE.txt
          Copy-Item "../../installer/assets/bitmaps/banner.bmp" .
          Copy-Item "../../installer/assets/bitmaps/dialog.bmp" .
          "Jarwis Security Agent - See https://jarwis.io for documentation" | Out-File -Encoding utf8 README.txt
          
          # List files for debugging
          Write-Host "Files in dist/windows:"
          Get-ChildItem -Name
          
          # Build MSI
          wix build "../../installer/windows/jarwis-agent.wxs" `
            -d SourceDir="." `
            -ext WixToolset.UI.wixext `
            -ext WixToolset.Util.wixext `
            -o jarwis-agent.msi
            
      - name: Build Inno Setup installer (User-friendly)
        run: |
          # Update version in ISS file
          $issContent = Get-Content "installer/inno/jarwis-agent.iss" -Raw
          $issContent = $issContent -replace '#define MyAppVersion ".*"', "#define MyAppVersion `"${{ env.VERSION }}`""
          Set-Content "installer/inno/jarwis-agent.iss" $issContent
          
          # Build installer
          iscc "installer/inno/jarwis-agent.iss"
          
      - name: Sign installers
        if: github.event.inputs.sign == 'true' || github.event_name == 'push'
        continue-on-error: true  # Allow build to continue if signing fails
        run: |
          az trustedsigning sign `
            --account-name ${{ secrets.AZURE_SIGNING_ACCOUNT }} `
            --certificate-profile ${{ secrets.AZURE_SIGNING_PROFILE }} `
            --endpoint https://eus.codesigning.azure.net `
            --files "dist/windows/jarwis-agent.msi" "dist/inno/jarwis-agent-${{ env.VERSION }}-setup.exe" `
            --description "Jarwis Security Agent Installer" `
            --timestamp-rfc3161 http://timestamp.acs.microsoft.com `
            --timestamp-digest SHA256
            
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            dist/windows/jarwis-agent.exe
            dist/windows/jarwis-tray.exe
            dist/windows/jarwis-config.exe
            dist/windows/JarwisAgentSetup-GUI.exe
            dist/windows/jarwis-agent.msi
            dist/inno/jarwis-agent-*-setup.exe
          retention-days: 30

  # ===========================================================================
  # macOS Build (Intel)
  # ===========================================================================
  build-macos-intel:
    name: Build macOS Installer (Intel)
    needs: preflight
    runs-on: macos-15  # Intel runner (updated from deprecated macos-13)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller PyQt6 Pillow
          pip install -r installer/requirements-agent.txt
          
      - name: Generate macOS app icon
        run: |
          # Check if iconset exists and generate .icns
          ICONSET_PATH="assets/logos/jarwis-agent.iconset"
          ICNS_PATH="assets/logos/jarwis-agent.icns"
          
          if [ -d "$ICONSET_PATH" ]; then
            iconutil -c icns "$ICONSET_PATH" -o "$ICNS_PATH"
            echo "Generated $ICNS_PATH from iconset"
          elif [ ! -f "$ICNS_PATH" ]; then
            echo "Warning: No iconset or icns found, using placeholder"
            # Create a minimal placeholder icns (optional)
          fi
          
      - name: Build executable with PyInstaller
        run: |
          pyinstaller installer/jarwis-agent.spec \
            --distpath dist/macos \
            --workpath dist/macos/build \
            --clean --noconfirm
            
      - name: Import signing certificates
        if: github.event.inputs.sign == 'true' || github.event_name == 'push'
        continue-on-error: true  # Allow build to continue if signing fails
        env:
          APPLE_CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_INSTALLER_CERTIFICATE_P12: ${{ secrets.APPLE_INSTALLER_CERTIFICATE_P12 }}
          APPLE_INSTALLER_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_INSTALLER_CERTIFICATE_PASSWORD }}
        run: |
          # Create temporary keychain
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          # Import application certificate
          echo "$APPLE_CERTIFICATE_P12" | base64 --decode > /tmp/app_cert.p12
          security import /tmp/app_cert.p12 -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
            
          # Import installer certificate
          echo "$APPLE_INSTALLER_CERTIFICATE_P12" | base64 --decode > /tmp/installer_cert.p12
          security import /tmp/installer_cert.p12 -P "$APPLE_INSTALLER_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          
          # Allow codesign to access keychain
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          
          rm /tmp/app_cert.p12 /tmp/installer_cert.p12
          
      - name: Sign executable
        if: github.event.inputs.sign == 'true' || github.event_name == 'push'
        continue-on-error: true  # Allow build to continue if signing fails
        run: |
          codesign --force --options runtime \
            --sign "Developer ID Application: Jarwis Security (${{ secrets.APPLE_TEAM_ID }})" \
            --entitlements installer/macos/entitlements.plist \
            --timestamp \
            dist/macos/jarwis-agent
            
      - name: Build PKG installer
        run: |
          chmod +x installer/macos/build.sh
          
          # Create package structure
          PKG_ROOT="dist/macos/pkg-root"
          mkdir -p "$PKG_ROOT/usr/local/bin"
          mkdir -p "$PKG_ROOT/Library/LaunchDaemons"
          mkdir -p "$PKG_ROOT/usr/local/etc/jarwis"
          
          cp dist/macos/jarwis-agent "$PKG_ROOT/usr/local/bin/"
          cp installer/macos/com.jarwis.agent.plist "$PKG_ROOT/Library/LaunchDaemons/"
          cp config/config.yaml "$PKG_ROOT/usr/local/etc/jarwis/"
          
          chmod 755 "$PKG_ROOT/usr/local/bin/jarwis-agent"
          chmod +x installer/macos/scripts/postinstall
          chmod +x installer/macos/scripts/preinstall
          
          # Build component package
          pkgbuild \
            --root "$PKG_ROOT" \
            --identifier "com.jarwis.agent" \
            --version "${{ env.VERSION }}" \
            --scripts "installer/macos/scripts" \
            --install-location "/" \
            "dist/macos/jarwis-agent-component.pkg"
            
          # Build product package with Intel suffix
          productbuild \
            --package "dist/macos/jarwis-agent-component.pkg" \
            "dist/macos/jarwis-agent-${{ env.VERSION }}-intel.pkg"
            
      - name: Sign PKG installer
        if: github.event.inputs.sign == 'true' || github.event_name == 'push'
        continue-on-error: true  # Allow build to continue if signing fails
        run: |
          productsign \
            --sign "Developer ID Installer: Jarwis Security (${{ secrets.APPLE_TEAM_ID }})" \
            --timestamp \
            "dist/macos/jarwis-agent-${{ env.VERSION }}-intel.pkg" \
            "dist/macos/jarwis-agent-${{ env.VERSION }}-intel-signed.pkg"
            
          mv "dist/macos/jarwis-agent-${{ env.VERSION }}-intel-signed.pkg" \
             "dist/macos/jarwis-agent-${{ env.VERSION }}-intel.pkg"
          
      - name: Notarize PKG
        if: github.event.inputs.sign == 'true' || github.event_name == 'push'
        continue-on-error: true  # Allow build to continue if signing fails
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          xcrun notarytool submit "dist/macos/jarwis-agent-${{ env.VERSION }}-intel.pkg" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --wait
            
          xcrun stapler staple "dist/macos/jarwis-agent-${{ env.VERSION }}-intel.pkg"
          
      - name: Create DMG
        run: |
          mkdir -p dist/macos/dmg-contents
          cp "dist/macos/jarwis-agent-${{ env.VERSION }}-intel.pkg" dist/macos/dmg-contents/
          cp README.md dist/macos/dmg-contents/README.txt
          
          hdiutil create \
            -volname "Jarwis Agent ${{ env.VERSION }} (Intel)" \
            -srcfolder dist/macos/dmg-contents \
            -ov \
            -format UDZO \
            "dist/macos/JarwisAgentSetup-${{ env.VERSION }}-intel.dmg"
            
      - name: Sign DMG
        if: github.event.inputs.sign == 'true' || github.event_name == 'push'
        continue-on-error: true  # Allow build to continue if signing fails
        run: |
          codesign --sign "Developer ID Application: Jarwis Security (${{ secrets.APPLE_TEAM_ID }})" \
            "dist/macos/JarwisAgentSetup-${{ env.VERSION }}-intel.dmg"
            
          xcrun notarytool submit "dist/macos/JarwisAgentSetup-${{ env.VERSION }}-intel.dmg" \
            --apple-id "${{ secrets.APPLE_ID }}" \
            --team-id "${{ secrets.APPLE_TEAM_ID }}" \
            --password "${{ secrets.APPLE_APP_PASSWORD }}" \
            --wait
            
          xcrun stapler staple "dist/macos/JarwisAgentSetup-${{ env.VERSION }}-intel.dmg"
          
      - name: Upload macOS Intel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel-installer
          path: |
            dist/macos/jarwis-agent-*-intel.pkg
            dist/macos/JarwisAgentSetup-*-intel.dmg
            dist/macos/jarwis-agent
          retention-days: 30

  # ===========================================================================
  # macOS Build (Apple Silicon)
  # ===========================================================================
  build-macos-arm64:
    name: Build macOS Installer (Apple Silicon)
    needs: preflight
    runs-on: macos-latest  # ARM64 runner (M1/M2)
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller PyQt6 Pillow
          pip install -r installer/requirements-agent.txt
          
      - name: Build executable with PyInstaller (ARM64)
        run: |
          pyinstaller installer/jarwis-agent.spec \
            --distpath dist/macos-arm64 \
            --workpath dist/macos-arm64/build \
            --clean --noconfirm
            
      - name: Import signing certificates
        if: github.event.inputs.sign == 'true' || github.event_name == 'push'
        continue-on-error: true  # Allow build to continue if signing fails
        env:
          APPLE_CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_INSTALLER_CERTIFICATE_P12: ${{ secrets.APPLE_INSTALLER_CERTIFICATE_P12 }}
          APPLE_INSTALLER_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_INSTALLER_CERTIFICATE_PASSWORD }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          echo "$APPLE_CERTIFICATE_P12" | base64 --decode > /tmp/app_cert.p12
          security import /tmp/app_cert.p12 -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
            
          echo "$APPLE_INSTALLER_CERTIFICATE_P12" | base64 --decode > /tmp/installer_cert.p12
          security import /tmp/installer_cert.p12 -P "$APPLE_INSTALLER_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          
          rm /tmp/app_cert.p12 /tmp/installer_cert.p12
          
      - name: Sign executable
        if: github.event.inputs.sign == 'true' || github.event_name == 'push'
        continue-on-error: true  # Allow build to continue if signing fails
        run: |
          codesign --force --options runtime \
            --sign "Developer ID Application: Jarwis Security (${{ secrets.APPLE_TEAM_ID }})" \
            --entitlements installer/macos/entitlements.plist \
            --timestamp \
            dist/macos-arm64/jarwis-agent
            
      - name: Build PKG installer (ARM64)
        run: |
          PKG_ROOT="dist/macos-arm64/pkg-root"
          mkdir -p "$PKG_ROOT/usr/local/bin"
          mkdir -p "$PKG_ROOT/Library/LaunchDaemons"
          mkdir -p "$PKG_ROOT/usr/local/etc/jarwis"
          
          cp dist/macos-arm64/jarwis-agent "$PKG_ROOT/usr/local/bin/"
          cp installer/macos/com.jarwis.agent.plist "$PKG_ROOT/Library/LaunchDaemons/"
          cp config/config.yaml "$PKG_ROOT/usr/local/etc/jarwis/"
          
          chmod 755 "$PKG_ROOT/usr/local/bin/jarwis-agent"
          chmod +x installer/macos/scripts/postinstall
          chmod +x installer/macos/scripts/preinstall
          
          pkgbuild \
            --root "$PKG_ROOT" \
            --identifier "com.jarwis.agent" \
            --version "${{ env.VERSION }}" \
            --scripts "installer/macos/scripts" \
            --install-location "/" \
            "dist/macos-arm64/jarwis-agent-component.pkg"
            
          productbuild \
            --package "dist/macos-arm64/jarwis-agent-component.pkg" \
            "dist/macos-arm64/jarwis-agent-${{ env.VERSION }}-apple-silicon.pkg"
            
      - name: Sign and notarize PKG
        if: github.event.inputs.sign == 'true' || github.event_name == 'push'
        continue-on-error: true  # Allow build to continue if signing fails
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          productsign \
            --sign "Developer ID Installer: Jarwis Security ($APPLE_TEAM_ID)" \
            --timestamp \
            "dist/macos-arm64/jarwis-agent-${{ env.VERSION }}-apple-silicon.pkg" \
            "dist/macos-arm64/jarwis-agent-${{ env.VERSION }}-apple-silicon-signed.pkg"
            
          mv "dist/macos-arm64/jarwis-agent-${{ env.VERSION }}-apple-silicon-signed.pkg" \
             "dist/macos-arm64/jarwis-agent-${{ env.VERSION }}-apple-silicon.pkg"
          
          xcrun notarytool submit "dist/macos-arm64/jarwis-agent-${{ env.VERSION }}-apple-silicon.pkg" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --wait
            
          xcrun stapler staple "dist/macos-arm64/jarwis-agent-${{ env.VERSION }}-apple-silicon.pkg"
          
      - name: Create DMG (ARM64)
        run: |
          mkdir -p dist/macos-arm64/dmg-contents
          cp "dist/macos-arm64/jarwis-agent-${{ env.VERSION }}-apple-silicon.pkg" dist/macos-arm64/dmg-contents/
          cp README.md dist/macos-arm64/dmg-contents/README.txt
          
          hdiutil create \
            -volname "Jarwis Agent ${{ env.VERSION }} (Apple Silicon)" \
            -srcfolder dist/macos-arm64/dmg-contents \
            -ov \
            -format UDZO \
            "dist/macos-arm64/JarwisAgentSetup-${{ env.VERSION }}-apple-silicon.dmg"
            
      - name: Upload macOS ARM64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-installer
          path: |
            dist/macos-arm64/jarwis-agent-*-apple-silicon.pkg
            dist/macos-arm64/JarwisAgentSetup-*-apple-silicon.dmg
            dist/macos-arm64/jarwis-agent
          retention-days: 30

  # ===========================================================================
  # Linux Build
  # ===========================================================================
  build-linux:
    name: Build Linux Installer
    needs: preflight
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller PyQt6 Pillow
          pip install -r installer/requirements-agent.txt
          
          # Install fpm for package building
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev rubygems rpm
          sudo gem install --no-document fpm
          
      - name: Build executable with PyInstaller
        run: |
          pyinstaller installer/jarwis-agent.spec \
            --distpath dist/linux \
            --workpath dist/linux/build \
            --clean --noconfirm
            
      - name: Build DEB package
        run: |
          PKG_ROOT="dist/linux/pkg-root"
          mkdir -p "$PKG_ROOT/usr/bin"
          mkdir -p "$PKG_ROOT/etc/jarwis"
          mkdir -p "$PKG_ROOT/lib/systemd/system"
          mkdir -p "$PKG_ROOT/var/log/jarwis"
          mkdir -p "$PKG_ROOT/var/lib/jarwis"
          
          cp dist/linux/jarwis-agent "$PKG_ROOT/usr/bin/"
          cp installer/linux/jarwis-agent.service "$PKG_ROOT/lib/systemd/system/"
          cp config/config.yaml "$PKG_ROOT/etc/jarwis/"
          
          chmod 755 "$PKG_ROOT/usr/bin/jarwis-agent"
          chmod +x installer/linux/postinstall.sh
          chmod +x installer/linux/preremove.sh
          chmod +x installer/linux/postremove.sh
          
          fpm -s dir -t deb \
            --name "jarwis-agent" \
            --version "${{ env.VERSION }}" \
            --architecture "amd64" \
            --maintainer "Jarwis Security <support@jarwis.io>" \
            --vendor "Jarwis Security" \
            --description "Jarwis Security Testing Agent" \
            --url "https://jarwis.io" \
            --license "Proprietary" \
            --depends "libc6" \
            --config-files "/etc/jarwis/config.yaml" \
            --after-install "installer/linux/postinstall.sh" \
            --before-remove "installer/linux/preremove.sh" \
            --after-remove "installer/linux/postremove.sh" \
            -C "$PKG_ROOT" \
            --package "dist/linux/jarwis-agent_${{ env.VERSION }}_amd64.deb" \
            .
            
      - name: Build RPM package
        run: |
          fpm -s dir -t rpm \
            --name "jarwis-agent" \
            --version "${{ env.VERSION }}" \
            --architecture "x86_64" \
            --maintainer "Jarwis Security <support@jarwis.io>" \
            --vendor "Jarwis Security" \
            --description "Jarwis Security Testing Agent" \
            --url "https://jarwis.io" \
            --license "Proprietary" \
            --depends "glibc" \
            --config-files "/etc/jarwis/config.yaml" \
            --after-install "installer/linux/postinstall.sh" \
            --before-remove "installer/linux/preremove.sh" \
            --after-remove "installer/linux/postremove.sh" \
            -C "dist/linux/pkg-root" \
            --package "dist/linux/jarwis-agent-${{ env.VERSION }}-1.x86_64.rpm" \
            .
            
      - name: Create basic tarball
        run: |
          tar -czf "dist/linux/jarwis-agent-${{ env.VERSION }}-linux-x86_64.tar.gz" \
            -C "dist/linux/pkg-root" \
            usr/bin/jarwis-agent \
            etc/jarwis \
            lib/systemd/system/jarwis-agent.service
            
      - name: Create GUI installer tarball
        run: |
          # Create installer package with install.sh script
          INSTALLER_DIR="dist/linux/installer-package"
          mkdir -p "$INSTALLER_DIR"
          
          # Copy binary and required files
          cp dist/linux/jarwis-agent "$INSTALLER_DIR/"
          cp installer/linux/jarwis-agent.service "$INSTALLER_DIR/"
          cp config/config.yaml "$INSTALLER_DIR/"
          cp installer/linux/postinstall.sh "$INSTALLER_DIR/"
          cp installer/linux/preremove.sh "$INSTALLER_DIR/"
          cp installer/linux/postremove.sh "$INSTALLER_DIR/"
          
          # Create install.sh wrapper script using echo commands (avoids heredoc YAML issues)
          echo '#!/bin/bash' > "$INSTALLER_DIR/install.sh"
          echo '# Jarwis Agent Installer' >> "$INSTALLER_DIR/install.sh"
          echo 'set -e' >> "$INSTALLER_DIR/install.sh"
          echo '' >> "$INSTALLER_DIR/install.sh"
          echo 'SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"' >> "$INSTALLER_DIR/install.sh"
          echo '' >> "$INSTALLER_DIR/install.sh"
          echo 'echo "Installing Jarwis Security Agent..."' >> "$INSTALLER_DIR/install.sh"
          echo '' >> "$INSTALLER_DIR/install.sh"
          echo '# Check root' >> "$INSTALLER_DIR/install.sh"
          echo 'if [ "$EUID" -ne 0 ]; then' >> "$INSTALLER_DIR/install.sh"
          echo '    echo "Please run as root (sudo ./install.sh)"' >> "$INSTALLER_DIR/install.sh"
          echo '    exit 1' >> "$INSTALLER_DIR/install.sh"
          echo 'fi' >> "$INSTALLER_DIR/install.sh"
          echo '' >> "$INSTALLER_DIR/install.sh"
          echo '# Install files' >> "$INSTALLER_DIR/install.sh"
          echo 'install -Dm755 "$SCRIPT_DIR/jarwis-agent" /usr/bin/jarwis-agent' >> "$INSTALLER_DIR/install.sh"
          echo 'install -Dm644 "$SCRIPT_DIR/jarwis-agent.service" /lib/systemd/system/jarwis-agent.service' >> "$INSTALLER_DIR/install.sh"
          echo 'install -Dm644 "$SCRIPT_DIR/config.yaml" /etc/jarwis/config.yaml' >> "$INSTALLER_DIR/install.sh"
          echo '' >> "$INSTALLER_DIR/install.sh"
          echo '# Create directories' >> "$INSTALLER_DIR/install.sh"
          echo 'mkdir -p /var/log/jarwis' >> "$INSTALLER_DIR/install.sh"
          echo 'mkdir -p /var/lib/jarwis' >> "$INSTALLER_DIR/install.sh"
          echo '' >> "$INSTALLER_DIR/install.sh"
          echo '# Run post-install' >> "$INSTALLER_DIR/install.sh"
          echo 'bash "$SCRIPT_DIR/postinstall.sh"' >> "$INSTALLER_DIR/install.sh"
          echo '' >> "$INSTALLER_DIR/install.sh"
          echo 'echo "Installation complete!"' >> "$INSTALLER_DIR/install.sh"
          echo 'echo "Configure with: jarwis-agent --configure"' >> "$INSTALLER_DIR/install.sh"
          echo 'echo "Start with: sudo systemctl start jarwis-agent"' >> "$INSTALLER_DIR/install.sh"
          
          chmod +x "$INSTALLER_DIR/install.sh"
          
          # Create the installer tarball
          tar -czf "dist/linux/jarwis-agent-${{ env.VERSION }}-linux-installer.tar.gz" \
            -C "dist/linux" \
            installer-package
            
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-installer
          path: |
            dist/linux/jarwis-agent_*_amd64.deb
            dist/linux/jarwis-agent-*-1.x86_64.rpm
            dist/linux/jarwis-agent-*-linux-x86_64.tar.gz
            dist/linux/jarwis-agent-*-linux-installer.tar.gz
          retention-days: 30

  # ===========================================================================
  # Create Release
  # ===========================================================================
  release:
    name: Create Release
    needs: [build-windows, build-macos-intel, build-macos-arm64, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts
          
      - name: List artifacts
        run: find artifacts -type f
        
      - name: Create GitHub Release
        uses: softprops/action-gh-release@v1
        with:
          name: Jarwis Agent ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Jarwis Security Agent ${{ github.ref_name }}
            
            ### ðŸš€ Installation
            
            **Windows (Recommended - GUI Installer):**
            Download `jarwis-agent-${{ github.ref_name }}-setup.exe` and run it.
            
            **Windows (Enterprise/Silent - MSI):**
            ```
            msiexec /i jarwis-agent.msi /quiet ACTIVATION_KEY=your-key
            ```
            
            **macOS (Intel):**
            Download `jarwis-agent-*-intel.pkg` or `JarwisAgentSetup-*-intel.dmg`
            
            **macOS (Apple Silicon M1/M2/M3):**
            Download `jarwis-agent-*-apple-silicon.pkg` or `JarwisAgentSetup-*-apple-silicon.dmg`
            
            **Linux (Debian/Ubuntu):**
            ```
            sudo dpkg -i jarwis-agent_*_amd64.deb
            ```
            
            **Linux (RHEL/CentOS/Fedora):**
            ```
            sudo rpm -i jarwis-agent-*.x86_64.rpm
            ```
            
            ### ðŸ“¦ Included Components
            - `jarwis-agent` - Main security testing agent
            - `jarwis-tray` - System tray status application (Windows)
            - `jarwis-config` - Configuration utility
            
            ### ðŸ“‹ Requirements
            - Windows 10/11 (64-bit)
            - macOS 11+ (Intel or Apple Silicon)
            - Linux (Ubuntu 20.04+, RHEL 8+, Debian 11+)
            - 4 GB RAM minimum
            - Internet connection for cloud features
            
            ### ðŸ”’ Troubleshooting
            See [Installation Troubleshooting Guide](https://jarwis.io/docs/agent/troubleshooting) for:
            - Windows SmartScreen bypass
            - macOS Gatekeeper warnings
            - Linux permission issues
            
          files: |
            artifacts/windows-installer/*
            artifacts/macos-intel-installer/*
            artifacts/macos-arm64-installer/*
            artifacts/linux-installer/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Upload to release server
        run: |
          echo "Would upload to https://releases.jarwis.io/agent/${{ github.ref_name }}/"
          # Add actual upload commands here (S3, Azure Blob, etc.)
