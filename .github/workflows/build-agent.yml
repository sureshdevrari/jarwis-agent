name: Build Agent Installers

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:

env:
  PYTHON_VERSION: '3.11'
  VERSION: '2.1.0'

jobs:
  build-windows:
    name: Windows Professional Installer
    runs-on: windows-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install pyinstaller PyQt6 Pillow pywin32 requests pyyaml
          pip install -r requirements.txt

      - name: Generate branding assets
        run: |
          cd installer/assets
          python create_icons.py

      - name: Build main agent executable
        run: |
          pyinstaller installer/jarwis-agent.spec --clean --noconfirm

      - name: Build system tray application
        run: |
          pyinstaller --name jarwis-tray --onefile --windowed --icon=installer/assets/icons/jarwis-agent.ico --add-data "assets/logos/PNG-01.png;assets/logos" installer/gui/system_tray.py

      - name: Build GUI setup wizard
        run: |
          pyinstaller --name JarwisAgentSetup-GUI --onefile --windowed --icon=installer/assets/icons/jarwis-agent.ico --add-data "assets/logos/PNG-01.png;assets/logos" --add-data "installer/LICENSE.rtf;." --add-data "config/config.yaml;config" --uac-admin installer/gui/setup_wizard.py

      - name: Install Inno Setup
        run: choco install innosetup -y

      - name: Build Inno Setup installer
        run: '& "C:\Program Files (x86)\Inno Setup 6\ISCC.exe" installer/inno/jarwis-agent.iss'
        continue-on-error: true

      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installers
          path: |
            dist/jarwis-agent.exe
            dist/jarwis-tray.exe
            dist/JarwisAgentSetup-GUI.exe
            dist/installer/JarwisAgentSetup-*.exe

  build-macos:
    name: macOS Professional Installer
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install pyinstaller PyQt6 Pillow requests pyyaml
          pip install -r requirements.txt

      - name: Generate branding assets
        run: |
          cd installer/assets
          python create_icons.py

      - name: Build main agent executable
        run: |
          pyinstaller installer/jarwis-agent.spec --clean --noconfirm
          mv dist/jarwis-agent dist/jarwis-agent-macos
          chmod +x dist/jarwis-agent-macos

      - name: Build system tray application
        run: |
          pyinstaller --name "Jarwis-Agent-Tray" --onefile --windowed --add-data "assets/logos/PNG-01.png:assets/logos" installer/gui/system_tray.py
          mv dist/Jarwis-Agent-Tray dist/jarwis-tray-macos
          chmod +x dist/jarwis-tray-macos

      - name: Build GUI setup wizard
        run: |
          pyinstaller --name "JarwisAgentSetup" --onefile --windowed --add-data "assets/logos/PNG-01.png:assets/logos" --add-data "installer/LICENSE.rtf:." --add-data "config/config.yaml:config" installer/macos/pkg/setup_wizard.py
          mv dist/JarwisAgentSetup dist/JarwisAgentSetup-macos
          chmod +x dist/JarwisAgentSetup-macos

      - name: Create DMG with installer
        run: |
          mkdir -p dmg-contents
          cp dist/JarwisAgentSetup-macos dmg-contents/Install-Jarwis-Agent
          chmod +x dmg-contents/Install-Jarwis-Agent
          hdiutil create -volname "Jarwis Agent Installer" -srcfolder dmg-contents -ov -format UDZO dist/JarwisAgentSetup-${{ env.VERSION }}.dmg

      - name: Upload macOS artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-installers
          path: |
            dist/jarwis-agent-macos
            dist/jarwis-tray-macos
            dist/JarwisAgentSetup-macos
            dist/JarwisAgentSetup-*.dmg

  build-linux:
    name: Linux Professional Installer
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y ruby ruby-dev rpm
          sudo apt-get install -y libxcb-cursor0 libxkbcommon-x11-0 libxcb-xinerama0 libxcb-icccm4 libxcb-image0 libxcb-keysyms1 libxcb-randr0 libxcb-render-util0 libxcb-shape0
          sudo gem install fpm --no-document

      - name: Install Python dependencies
        run: |
          pip install pyinstaller PyQt6 Pillow requests pyyaml
          pip install -r requirements.txt

      - name: Generate branding assets
        run: |
          cd installer/assets
          python create_icons.py

      - name: Build main agent executable
        run: |
          pyinstaller installer/jarwis-agent.spec --clean --noconfirm
          chmod +x dist/jarwis-agent
          mv dist/jarwis-agent dist/jarwis-agent-linux

      - name: Build system tray application
        run: |
          pyinstaller --name jarwis-tray --onefile --add-data "assets/logos/PNG-01.png:assets/logos" installer/gui/system_tray.py
          chmod +x dist/jarwis-tray
          mv dist/jarwis-tray dist/jarwis-tray-linux

      - name: Build GUI setup wizard
        run: |
          pyinstaller --name jarwis-setup --onefile --add-data "assets/logos/PNG-01.png:assets/logos" --add-data "installer/LICENSE.rtf:." --add-data "config/config.yaml:config" installer/linux/gui/setup_wizard.py
          chmod +x dist/jarwis-setup
          mv dist/jarwis-setup dist/JarwisAgentSetup-linux

      - name: Create installer tarball
        run: |
          VERSION="${{ env.VERSION }}"
          mkdir -p installer-package
          cp dist/jarwis-agent-linux installer-package/jarwis-agent
          cp dist/jarwis-tray-linux installer-package/jarwis-tray
          cp dist/JarwisAgentSetup-linux installer-package/install-jarwis
          cp config/config.yaml installer-package/
          cp installer/LICENSE.rtf installer-package/
          cp assets/logos/PNG-01.png installer-package/
          echo '#!/bin/bash' > installer-package/install.sh
          echo 'echo "Jarwis Security Agent Installer"' >> installer-package/install.sh
          echo 'if [ -n "$DISPLAY" ] && [ -x ./install-jarwis ]; then' >> installer-package/install.sh
          echo '  ./install-jarwis' >> installer-package/install.sh
          echo 'else' >> installer-package/install.sh
          echo '  sudo mkdir -p /opt/jarwis/bin /opt/jarwis/config' >> installer-package/install.sh
          echo '  sudo cp jarwis-agent jarwis-tray /opt/jarwis/bin/' >> installer-package/install.sh
          echo '  sudo cp config.yaml /opt/jarwis/config/' >> installer-package/install.sh
          echo '  sudo chmod +x /opt/jarwis/bin/*' >> installer-package/install.sh
          echo '  echo "Installation complete!"' >> installer-package/install.sh
          echo 'fi' >> installer-package/install.sh
          chmod +x installer-package/install.sh
          tar -czvf dist/jarwis-agent-${VERSION}-linux-installer.tar.gz -C installer-package .

      - name: Create DEB package
        run: |
          VERSION="${{ env.VERSION }}"
          mkdir -p pkg-root/opt/jarwis/bin
          mkdir -p pkg-root/opt/jarwis/config
          mkdir -p pkg-root/opt/jarwis/logs
          mkdir -p pkg-root/lib/systemd/system
          mkdir -p pkg-root/usr/local/bin
          mkdir -p pkg-root/usr/share/applications
          mkdir -p pkg-root/usr/share/icons/hicolor/256x256/apps
          cp dist/jarwis-agent-linux pkg-root/opt/jarwis/bin/jarwis-agent
          cp dist/jarwis-tray-linux pkg-root/opt/jarwis/bin/jarwis-tray
          cp dist/JarwisAgentSetup-linux pkg-root/opt/jarwis/bin/jarwis-setup
          cp config/config.yaml pkg-root/opt/jarwis/config/
          cp assets/logos/PNG-01.png pkg-root/usr/share/icons/hicolor/256x256/apps/jarwis-agent.png
          chmod 755 pkg-root/opt/jarwis/bin/*
          ln -s /opt/jarwis/bin/jarwis-agent pkg-root/usr/local/bin/jarwis-agent
          ln -s /opt/jarwis/bin/jarwis-tray pkg-root/usr/local/bin/jarwis-tray
          echo '[Unit]' > pkg-root/lib/systemd/system/jarwis-agent.service
          echo 'Description=Jarwis Security Agent' >> pkg-root/lib/systemd/system/jarwis-agent.service
          echo 'After=network-online.target' >> pkg-root/lib/systemd/system/jarwis-agent.service
          echo '' >> pkg-root/lib/systemd/system/jarwis-agent.service
          echo '[Service]' >> pkg-root/lib/systemd/system/jarwis-agent.service
          echo 'Type=simple' >> pkg-root/lib/systemd/system/jarwis-agent.service
          echo 'ExecStart=/opt/jarwis/bin/jarwis-agent --daemon' >> pkg-root/lib/systemd/system/jarwis-agent.service
          echo 'Restart=always' >> pkg-root/lib/systemd/system/jarwis-agent.service
          echo 'RestartSec=10' >> pkg-root/lib/systemd/system/jarwis-agent.service
          echo '' >> pkg-root/lib/systemd/system/jarwis-agent.service
          echo '[Install]' >> pkg-root/lib/systemd/system/jarwis-agent.service
          echo 'WantedBy=multi-user.target' >> pkg-root/lib/systemd/system/jarwis-agent.service
          echo '[Desktop Entry]' > pkg-root/usr/share/applications/jarwis-agent.desktop
          echo 'Name=Jarwis Agent' >> pkg-root/usr/share/applications/jarwis-agent.desktop
          echo 'Comment=Jarwis Security Agent' >> pkg-root/usr/share/applications/jarwis-agent.desktop
          echo 'Exec=/opt/jarwis/bin/jarwis-tray' >> pkg-root/usr/share/applications/jarwis-agent.desktop
          echo 'Icon=jarwis-agent' >> pkg-root/usr/share/applications/jarwis-agent.desktop
          echo 'Type=Application' >> pkg-root/usr/share/applications/jarwis-agent.desktop
          echo 'Categories=System;Security;' >> pkg-root/usr/share/applications/jarwis-agent.desktop
          mkdir -p scripts
          echo '#!/bin/bash' > scripts/postinstall.sh
          echo 'systemctl daemon-reload' >> scripts/postinstall.sh
          echo 'systemctl enable jarwis-agent' >> scripts/postinstall.sh
          chmod +x scripts/postinstall.sh
          fpm -s dir -t deb --name jarwis-agent --version $VERSION --architecture amd64 --maintainer "Jarwis Security <support@jarwis.ai>" --description "Jarwis Security Agent" --url "https://jarwis.ai" --license "Proprietary" --after-install scripts/postinstall.sh -C pkg-root --package dist/jarwis-agent_${VERSION}_amd64.deb .

      - name: Create RPM package
        run: |
          VERSION="${{ env.VERSION }}"
          fpm -s dir -t rpm --name jarwis-agent --version $VERSION --architecture x86_64 --maintainer "Jarwis Security <support@jarwis.ai>" --description "Jarwis Security Agent" --url "https://jarwis.ai" --license "Proprietary" --after-install scripts/postinstall.sh -C pkg-root --package dist/jarwis-agent-${VERSION}-1.x86_64.rpm .

      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-installers
          path: |
            dist/jarwis-agent-linux
            dist/jarwis-tray-linux
            dist/JarwisAgentSetup-linux
            dist/*.tar.gz
            dist/*.deb
            dist/*.rpm

  release:
    name: Create Release
    needs: [build-windows, build-macos, build-linux]
    runs-on: ubuntu-latest
    if: startsWith(github.ref, 'refs/tags/v')
    permissions:
      contents: write
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: List files
        run: find artifacts -type f

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Jarwis Agent ${{ github.ref_name }}
          body: |
            ## Jarwis Security Agent ${{ github.ref_name }}
            
            ### Downloads
            
            **Windows:** JarwisAgentSetup-GUI.exe (Recommended)
            **macOS:** JarwisAgentSetup-${{ env.VERSION }}.dmg
            **Linux:** jarwis-agent_${{ env.VERSION }}_amd64.deb or .rpm
            
            ### Features
            - Professional GUI Installation Wizard
            - EULA/License Agreement
            - Feature Selection
            - Server Configuration
            - System Tray Application
            - Auto-start Service
          files: |
            artifacts/windows-installers/*
            artifacts/macos-installers/*
            artifacts/linux-installers/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
