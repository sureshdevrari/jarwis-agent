# ===========================================================================
# Jarwis Agent - CI/CD Build Pipeline (v2) (Unsigned Build Support)
# ===========================================================================
#
# Builds and releases native installers for Windows, macOS, and Linux.
# Supports both signed and unsigned builds - unsigned is the default.
# 
# Triggers:
#   - Push to 'release/*' branches
#   - Manual dispatch
#   - Tags matching 'v*'
#
# Signing (Optional):
#   Signing only runs when ALL required secrets are configured AND
#   either sign=true in workflow_dispatch or it's a push event.
#   Without secrets, builds complete successfully as unsigned.
#
# Required Secrets (for signed builds):
#   Windows (Azure Trusted Signing):
#     - AZURE_CLIENT_ID
#     - AZURE_CLIENT_SECRET
#     - AZURE_TENANT_ID
#     - AZURE_SIGNING_ACCOUNT
#     - AZURE_SIGNING_PROFILE
#
#   macOS (Apple Developer):
#     - APPLE_CERTIFICATE_P12
#     - APPLE_CERTIFICATE_PASSWORD
#     - APPLE_INSTALLER_CERTIFICATE_P12
#     - APPLE_INSTALLER_CERTIFICATE_PASSWORD
#     - APPLE_TEAM_ID
#     - APPLE_ID
#     - APPLE_APP_PASSWORD
#
#   Release:
#     - GITHUB_TOKEN (automatic)
#
# ===========================================================================

name: Build Agent Installers

on:
  push:
    branches:
      - main
      - release/*
    tags:
      - 'v*'
  pull_request:
    branches:
      - main
  workflow_dispatch:
    inputs:
      version:
        description: 'Version to build (e.g., 2.1.0)'
        required: false
        default: '2.1.0'
      sign:
        description: 'Sign the installers (requires secrets to be configured)'
        type: boolean
        required: false
        default: false

env:
  PYTHON_VERSION: '3.11'

jobs:
  # ===========================================================================
  # Pre-flight Check
  # ===========================================================================
  preflight:
    name: Pre-flight Validation
    runs-on: ubuntu-latest
    outputs:
      windows_signing: ${{ steps.check-secrets.outputs.windows_signing }}
      macos_signing: ${{ steps.check-secrets.outputs.macos_signing }}
      version: ${{ steps.set-version.outputs.version }}
    steps:
      - name: Set version from tag or input
        id: set-version
        run: |
          if [[ "${{ github.ref }}" == refs/tags/v* ]]; then
            # Extract version from tag (remove 'v' prefix)
            VERSION="${{ github.ref_name }}"
            VERSION="${VERSION#v}"
          else
            # Use input or default
            VERSION="${{ github.event.inputs.version || '2.1.0' }}"
          fi
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Using version: $VERSION"
          
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Check signing secrets availability
        id: check-secrets
        run: |
          # Check Windows signing secrets
          if [ -n "${{ secrets.AZURE_CLIENT_ID }}" ] && [ -n "${{ secrets.AZURE_TENANT_ID }}" ]; then
            echo "windows_signing=true" >> $GITHUB_OUTPUT
            echo "✅ Windows signing secrets are configured"
          else
            echo "windows_signing=false" >> $GITHUB_OUTPUT
            echo "ℹ️ Windows signing secrets not configured - will build unsigned"
          fi
          
          # Check macOS signing secrets
          if [ -n "${{ secrets.APPLE_CERTIFICATE_P12 }}" ] && [ -n "${{ secrets.APPLE_TEAM_ID }}" ]; then
            echo "macos_signing=true" >> $GITHUB_OUTPUT
            echo "✅ macOS signing secrets are configured"
          else
            echo "macos_signing=false" >> $GITHUB_OUTPUT
            echo "ℹ️ macOS signing secrets not configured - will use ad-hoc signing"
          fi
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          
      - name: Run pre-flight checks
        run: |
          pip install pillow
          python installer/preflight_check.py --platform all || true
          echo "Pre-flight checks completed"

  # ===========================================================================
  # Windows Build
  # ===========================================================================
  build-windows:
    needs: preflight
    name: Build Windows Installer
    runs-on: windows-latest
    env:
      VERSION: ${{ needs.preflight.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller PyQt6 Pillow pywin32
          pip install -r installer/requirements-agent.txt
          
      - name: Generate branding assets
        run: |
          python installer/assets/create_icons.py
        continue-on-error: true
          
      - name: Build main executable with PyInstaller
        run: |
          pyinstaller installer/jarwis-agent.spec `
            --distpath dist/jarwis-agent `
            --workpath dist/build `
            --clean --noconfirm
          
          # Copy to windows folder for installer builds
          New-Item -ItemType Directory -Force -Path dist/windows
          Copy-Item dist/jarwis-agent/* dist/windows/ -Recurse -Force
            
      - name: Build GUI Setup Wizard
        run: |
          pyinstaller installer/jarwis-setup-gui.spec `
            --distpath dist/windows `
            --workpath dist/windows/build `
            --clean --noconfirm
            
      - name: Build System Tray App
        run: |
          pyinstaller installer/jarwis-tray.spec `
            --distpath dist/windows `
            --workpath dist/windows/build `
            --clean --noconfirm
            
      - name: Build Config Tool
        run: |
          pyinstaller installer/jarwis-config.spec `
            --distpath dist/windows `
            --workpath dist/windows/build `
            --clean --noconfirm

      # === OPTIONAL SIGNING (only if secrets configured) ===
      - name: Install Azure CLI (for signing)
        if: needs.preflight.outputs.windows_signing == 'true' && (github.event.inputs.sign == 'true' || github.event_name == 'push')
        run: |
          Invoke-WebRequest -Uri https://aka.ms/installazurecliwindows -OutFile AzureCLI.msi
          Start-Process msiexec.exe -Wait -ArgumentList '/I AzureCLI.msi /quiet'
          
      - name: Sign executables with Azure Trusted Signing
        if: needs.preflight.outputs.windows_signing == 'true' && (github.event.inputs.sign == 'true' || github.event_name == 'push')
        env:
          AZURE_CLIENT_ID: ${{ secrets.AZURE_CLIENT_ID }}
          AZURE_CLIENT_SECRET: ${{ secrets.AZURE_CLIENT_SECRET }}
          AZURE_TENANT_ID: ${{ secrets.AZURE_TENANT_ID }}
        run: |
          az login --service-principal `
            -u $env:AZURE_CLIENT_ID `
            -p $env:AZURE_CLIENT_SECRET `
            --tenant $env:AZURE_TENANT_ID
            
          az trustedsigning sign `
            --account-name ${{ secrets.AZURE_SIGNING_ACCOUNT }} `
            --certificate-profile ${{ secrets.AZURE_SIGNING_PROFILE }} `
            --endpoint https://eus.codesigning.azure.net `
            --files "dist/windows/jarwis-agent.exe" "dist/windows/jarwis-tray.exe" "dist/windows/jarwis-config.exe" "dist/windows/JarwisAgentSetup-GUI.exe" `
            --description "Jarwis Security Agent" `
            --timestamp-rfc3161 http://timestamp.acs.microsoft.com `
            --timestamp-digest SHA256
        continue-on-error: true

      # === WiX 4 MSI BUILD ===
      - name: Install WiX Toolset 4
        run: |
          dotnet tool install --global wix --version 4.0.5
          wix extension add WixToolset.UI.wixext/4.0.5 -g
          wix extension add WixToolset.Util.wixext/4.0.5 -g
          
      - name: Prepare MSI build files
        run: |
          cd dist/windows
          
          # Copy required files for WiX
          Copy-Item "../../config/config.yaml" .
          Copy-Item "../../installer/LICENSE.rtf" ./license.rtf
          Copy-Item "../../installer/assets/bitmaps/banner.bmp" .
          Copy-Item "../../installer/assets/bitmaps/dialog.bmp" .
          Copy-Item "../../installer/assets/icons/jarwis-agent.ico" ./jarwis-agent.ico
          "Jarwis Security Agent - See https://jarwis.io for documentation" | Out-File -Encoding utf8 README.txt
          "MIT License - See https://jarwis.io/license" | Out-File -Encoding utf8 LICENSE.txt
          
          # List files for debugging
          Write-Host "Files prepared for MSI build:"
          Get-ChildItem -Name
          
      - name: Build MSI installer (WiX 4)
        run: |
          cd dist/windows
          wix build "../../installer/windows/jarwis-agent-v4.wxs" `
            -d SourceDir="." `
            -ext WixToolset.UI.wixext `
            -ext WixToolset.Util.wixext `
            -o jarwis-agent-${{ env.VERSION }}.msi

      # === SIGN MSI (Optional - only if secrets configured) ===
      - name: Sign MSI installer
        if: needs.preflight.outputs.windows_signing == 'true' && (github.event.inputs.sign == 'true' || github.event_name == 'push')
        run: |
          if (Test-Path "dist/windows/jarwis-agent-${{ env.VERSION }}.msi") {
            az trustedsigning sign `
              --account-name ${{ secrets.AZURE_SIGNING_ACCOUNT }} `
              --certificate-profile ${{ secrets.AZURE_SIGNING_PROFILE }} `
              --endpoint https://eus.codesigning.azure.net `
              --files "dist/windows/jarwis-agent-${{ env.VERSION }}.msi" `
              --description "Jarwis Security Agent Installer" `
              --timestamp-rfc3161 http://timestamp.acs.microsoft.com `
              --timestamp-digest SHA256
          }
        continue-on-error: true
            
      - name: Upload Windows artifacts
        uses: actions/upload-artifact@v4
        with:
          name: windows-installer
          path: |
            dist/windows/jarwis-agent.exe
            dist/windows/jarwis-tray.exe
            dist/windows/jarwis-config.exe
            dist/windows/JarwisAgentSetup-GUI.exe
            dist/windows/*.msi
          retention-days: 30
          if-no-files-found: error

  # ===========================================================================
  # macOS Build (Intel)
  # ===========================================================================
  build-macos-intel:
    name: Build macOS Installer (Intel)
    needs: preflight
    runs-on: macos-15-intel  # Intel runner (macos-13 retired, using macos-15-intel per https://github.com/actions/runner-images/issues/13046)
    env:
      VERSION: ${{ needs.preflight.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller PyQt6 Pillow
          pip install -r installer/requirements-agent.txt
          
      - name: Generate macOS app icon
        run: |
          # Generate .icns from iconset if available
          if [ -d "installer/assets/icons/jarwis-agent.iconset" ]; then
            iconutil -c icns "installer/assets/icons/jarwis-agent.iconset" -o "installer/assets/icons/jarwis-agent.icns"
            echo "✅ Generated .icns from iconset"
          elif [ -f "installer/assets/icons/jarwis-agent.icns" ]; then
            echo "✅ Using existing .icns file"
          else
            echo "⚠️ No icon available, build will use default"
          fi
        continue-on-error: true
          
      - name: Build executable with PyInstaller (ad-hoc signed)
        run: |
          # PyInstaller automatically performs ad-hoc signing on macOS
          pyinstaller installer/jarwis-agent.spec \
            --distpath dist/macos \
            --workpath dist/macos/build \
            --clean --noconfirm
          
          # Verify the executable
          ls -la dist/macos/
          file dist/macos/jarwis-agent || true
          
          # Ad-hoc sign explicitly for Gatekeeper compatibility
          codesign --sign - --force --deep dist/macos/jarwis-agent || true
          codesign -vv dist/macos/jarwis-agent || true
            
      # === OPTIONAL: Full signing with Apple Developer certificate ===
      - name: Import signing certificates
        if: needs.preflight.outputs.macos_signing == 'true' && (github.event.inputs.sign == 'true' || github.event_name == 'push')
        env:
          APPLE_CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_INSTALLER_CERTIFICATE_P12: ${{ secrets.APPLE_INSTALLER_CERTIFICATE_P12 }}
          APPLE_INSTALLER_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_INSTALLER_CERTIFICATE_PASSWORD }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          echo "$APPLE_CERTIFICATE_P12" | base64 --decode > /tmp/app_cert.p12
          security import /tmp/app_cert.p12 -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
            
          echo "$APPLE_INSTALLER_CERTIFICATE_P12" | base64 --decode > /tmp/installer_cert.p12
          security import /tmp/installer_cert.p12 -P "$APPLE_INSTALLER_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          
          rm /tmp/app_cert.p12 /tmp/installer_cert.p12
          
      - name: Sign executable with Developer ID
        if: needs.preflight.outputs.macos_signing == 'true' && (github.event.inputs.sign == 'true' || github.event_name == 'push')
        run: |
          codesign --force --options runtime \
            --sign "Developer ID Application: Jarwis Security (${{ secrets.APPLE_TEAM_ID }})" \
            --entitlements installer/macos/entitlements.plist \
            --timestamp \
            dist/macos/jarwis-agent
        continue-on-error: true
            
      - name: Build PKG installer
        run: |
          # Create package structure
          PKG_ROOT="dist/macos/pkg-root"
          mkdir -p "$PKG_ROOT/usr/local/bin"
          mkdir -p "$PKG_ROOT/Library/LaunchDaemons"
          mkdir -p "$PKG_ROOT/usr/local/etc/jarwis"
          
          cp dist/macos/jarwis-agent "$PKG_ROOT/usr/local/bin/"
          cp installer/macos/com.jarwis.agent.plist "$PKG_ROOT/Library/LaunchDaemons/" || true
          cp config/config.yaml "$PKG_ROOT/usr/local/etc/jarwis/"
          
          chmod 755 "$PKG_ROOT/usr/local/bin/jarwis-agent"
          chmod +x installer/macos/scripts/postinstall || true
          chmod +x installer/macos/scripts/preinstall || true
          
          # Build component package (unsigned)
          pkgbuild \
            --root "$PKG_ROOT" \
            --identifier "com.jarwis.agent" \
            --version "${{ env.VERSION }}" \
            --scripts "installer/macos/scripts" \
            --install-location "/" \
            "dist/macos/jarwis-agent-component.pkg" || \
          pkgbuild \
            --root "$PKG_ROOT" \
            --identifier "com.jarwis.agent" \
            --version "${{ env.VERSION }}" \
            --install-location "/" \
            "dist/macos/jarwis-agent-component.pkg"
            
          # Build product package
          productbuild \
            --package "dist/macos/jarwis-agent-component.pkg" \
            "dist/macos/jarwis-agent-${{ env.VERSION }}-intel.pkg"
            
      - name: Sign and notarize PKG
        if: needs.preflight.outputs.macos_signing == 'true' && (github.event.inputs.sign == 'true' || github.event_name == 'push')
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          productsign \
            --sign "Developer ID Installer: Jarwis Security ($APPLE_TEAM_ID)" \
            --timestamp \
            "dist/macos/jarwis-agent-${{ env.VERSION }}-intel.pkg" \
            "dist/macos/jarwis-agent-${{ env.VERSION }}-intel-signed.pkg"
            
          mv "dist/macos/jarwis-agent-${{ env.VERSION }}-intel-signed.pkg" \
             "dist/macos/jarwis-agent-${{ env.VERSION }}-intel.pkg"
          
          xcrun notarytool submit "dist/macos/jarwis-agent-${{ env.VERSION }}-intel.pkg" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --wait
            
          xcrun stapler staple "dist/macos/jarwis-agent-${{ env.VERSION }}-intel.pkg"
        continue-on-error: true
          
      - name: Create DMG
        run: |
          mkdir -p dist/macos/dmg-contents
          cp "dist/macos/jarwis-agent-${{ env.VERSION }}-intel.pkg" dist/macos/dmg-contents/
          cp README.md dist/macos/dmg-contents/README.txt
          echo "See INSTALLATION.md for security warning bypass instructions" > dist/macos/dmg-contents/IMPORTANT.txt
          
          hdiutil create \
            -volname "Jarwis Agent ${{ env.VERSION }} (Intel)" \
            -srcfolder dist/macos/dmg-contents \
            -ov \
            -format UDZO \
            "dist/macos/JarwisAgentSetup-${{ env.VERSION }}-intel.dmg"
            
      - name: Upload macOS Intel artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-intel-installer
          path: |
            dist/macos/jarwis-agent-*-intel.pkg
            dist/macos/JarwisAgentSetup-*-intel.dmg
            dist/macos/jarwis-agent
          retention-days: 30
          if-no-files-found: error

  # ===========================================================================
  # macOS Build (Apple Silicon)
  # ===========================================================================
  build-macos-arm64:
    name: Build macOS Installer (Apple Silicon)
    needs: preflight
    runs-on: macos-latest  # ARM64 runner (M1/M2)
    env:
      VERSION: ${{ needs.preflight.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller PyQt6 Pillow
          pip install -r installer/requirements-agent.txt
          
      - name: Build executable with PyInstaller (ad-hoc signed)
        run: |
          pyinstaller installer/jarwis-agent.spec \
            --distpath dist/macos-arm64 \
            --workpath dist/macos-arm64/build \
            --clean --noconfirm
          
          # Ad-hoc sign for Gatekeeper compatibility
          codesign --sign - --force --deep dist/macos-arm64/jarwis-agent || true
            
      # === OPTIONAL: Full signing with Apple Developer certificate ===
      - name: Import signing certificates
        if: needs.preflight.outputs.macos_signing == 'true' && (github.event.inputs.sign == 'true' || github.event_name == 'push')
        env:
          APPLE_CERTIFICATE_P12: ${{ secrets.APPLE_CERTIFICATE_P12 }}
          APPLE_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_CERTIFICATE_PASSWORD }}
          APPLE_INSTALLER_CERTIFICATE_P12: ${{ secrets.APPLE_INSTALLER_CERTIFICATE_P12 }}
          APPLE_INSTALLER_CERTIFICATE_PASSWORD: ${{ secrets.APPLE_INSTALLER_CERTIFICATE_PASSWORD }}
        run: |
          KEYCHAIN_PATH=$RUNNER_TEMP/signing.keychain-db
          KEYCHAIN_PASSWORD=$(openssl rand -base64 32)
          
          security create-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security set-keychain-settings -lut 21600 "$KEYCHAIN_PATH"
          security unlock-keychain -p "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          
          echo "$APPLE_CERTIFICATE_P12" | base64 --decode > /tmp/app_cert.p12
          security import /tmp/app_cert.p12 -P "$APPLE_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
            
          echo "$APPLE_INSTALLER_CERTIFICATE_P12" | base64 --decode > /tmp/installer_cert.p12
          security import /tmp/installer_cert.p12 -P "$APPLE_INSTALLER_CERTIFICATE_PASSWORD" \
            -A -t cert -f pkcs12 -k "$KEYCHAIN_PATH"
          
          security set-key-partition-list -S apple-tool:,apple: -s -k "$KEYCHAIN_PASSWORD" "$KEYCHAIN_PATH"
          security list-keychain -d user -s "$KEYCHAIN_PATH"
          
          rm /tmp/app_cert.p12 /tmp/installer_cert.p12
          
      - name: Sign executable with Developer ID
        if: needs.preflight.outputs.macos_signing == 'true' && (github.event.inputs.sign == 'true' || github.event_name == 'push')
        run: |
          codesign --force --options runtime \
            --sign "Developer ID Application: Jarwis Security (${{ secrets.APPLE_TEAM_ID }})" \
            --entitlements installer/macos/entitlements.plist \
            --timestamp \
            dist/macos-arm64/jarwis-agent
        continue-on-error: true
            
      - name: Build PKG installer (ARM64)
        run: |
          PKG_ROOT="dist/macos-arm64/pkg-root"
          mkdir -p "$PKG_ROOT/usr/local/bin"
          mkdir -p "$PKG_ROOT/Library/LaunchDaemons"
          mkdir -p "$PKG_ROOT/usr/local/etc/jarwis"
          
          cp dist/macos-arm64/jarwis-agent "$PKG_ROOT/usr/local/bin/"
          cp installer/macos/com.jarwis.agent.plist "$PKG_ROOT/Library/LaunchDaemons/" || true
          cp config/config.yaml "$PKG_ROOT/usr/local/etc/jarwis/"
          
          chmod 755 "$PKG_ROOT/usr/local/bin/jarwis-agent"
          
          pkgbuild \
            --root "$PKG_ROOT" \
            --identifier "com.jarwis.agent" \
            --version "${{ env.VERSION }}" \
            --scripts "installer/macos/scripts" \
            --install-location "/" \
            "dist/macos-arm64/jarwis-agent-component.pkg" || \
          pkgbuild \
            --root "$PKG_ROOT" \
            --identifier "com.jarwis.agent" \
            --version "${{ env.VERSION }}" \
            --install-location "/" \
            "dist/macos-arm64/jarwis-agent-component.pkg"
            
          productbuild \
            --package "dist/macos-arm64/jarwis-agent-component.pkg" \
            "dist/macos-arm64/jarwis-agent-${{ env.VERSION }}-apple-silicon.pkg"
            
      - name: Sign and notarize PKG
        if: needs.preflight.outputs.macos_signing == 'true' && (github.event.inputs.sign == 'true' || github.event_name == 'push')
        env:
          APPLE_ID: ${{ secrets.APPLE_ID }}
          APPLE_TEAM_ID: ${{ secrets.APPLE_TEAM_ID }}
          APPLE_APP_PASSWORD: ${{ secrets.APPLE_APP_PASSWORD }}
        run: |
          productsign \
            --sign "Developer ID Installer: Jarwis Security ($APPLE_TEAM_ID)" \
            --timestamp \
            "dist/macos-arm64/jarwis-agent-${{ env.VERSION }}-apple-silicon.pkg" \
            "dist/macos-arm64/jarwis-agent-${{ env.VERSION }}-apple-silicon-signed.pkg"
            
          mv "dist/macos-arm64/jarwis-agent-${{ env.VERSION }}-apple-silicon-signed.pkg" \
             "dist/macos-arm64/jarwis-agent-${{ env.VERSION }}-apple-silicon.pkg"
          
          xcrun notarytool submit "dist/macos-arm64/jarwis-agent-${{ env.VERSION }}-apple-silicon.pkg" \
            --apple-id "$APPLE_ID" \
            --team-id "$APPLE_TEAM_ID" \
            --password "$APPLE_APP_PASSWORD" \
            --wait
            
          xcrun stapler staple "dist/macos-arm64/jarwis-agent-${{ env.VERSION }}-apple-silicon.pkg"
        continue-on-error: true
          
      - name: Create DMG (ARM64)
        run: |
          mkdir -p dist/macos-arm64/dmg-contents
          cp "dist/macos-arm64/jarwis-agent-${{ env.VERSION }}-apple-silicon.pkg" dist/macos-arm64/dmg-contents/
          cp README.md dist/macos-arm64/dmg-contents/README.txt
          
          hdiutil create \
            -volname "Jarwis Agent ${{ env.VERSION }} (Apple Silicon)" \
            -srcfolder dist/macos-arm64/dmg-contents \
            -ov \
            -format UDZO \
            "dist/macos-arm64/JarwisAgentSetup-${{ env.VERSION }}-apple-silicon.dmg"
            
      - name: Upload macOS ARM64 artifacts
        uses: actions/upload-artifact@v4
        with:
          name: macos-arm64-installer
          path: |
            dist/macos-arm64/jarwis-agent-*-apple-silicon.pkg
            dist/macos-arm64/JarwisAgentSetup-*-apple-silicon.dmg
            dist/macos-arm64/jarwis-agent
          retention-days: 30
          if-no-files-found: error

  # ===========================================================================
  # Linux Build
  # ===========================================================================
  build-linux:
    name: Build Linux Installer
    needs: preflight
    runs-on: ubuntu-22.04
    env:
      VERSION: ${{ needs.preflight.outputs.version }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          cache: 'pip'
          
      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            ruby ruby-dev rubygems rpm \
            libxcb-xinerama0 libxkbcommon-x11-0 \
            libegl1 libxcb-cursor0
          
      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pyinstaller PyQt6 Pillow
          pip install -r installer/requirements-agent.txt
          
      - name: Install FPM
        run: |
          sudo gem install --no-document fpm
          
      - name: Build executable with PyInstaller
        run: |
          pyinstaller installer/jarwis-agent.spec \
            --distpath dist/linux \
            --workpath dist/linux/build \
            --clean --noconfirm
            
      - name: Prepare package structure
        run: |
          PKG_ROOT="dist/linux/pkg-root"
          mkdir -p "$PKG_ROOT/usr/bin"
          mkdir -p "$PKG_ROOT/etc/jarwis"
          mkdir -p "$PKG_ROOT/lib/systemd/system"
          mkdir -p "$PKG_ROOT/var/log/jarwis"
          mkdir -p "$PKG_ROOT/var/lib/jarwis"
          
          cp dist/linux/jarwis-agent "$PKG_ROOT/usr/bin/"
          cp installer/linux/jarwis-agent.service "$PKG_ROOT/lib/systemd/system/"
          cp config/config.yaml "$PKG_ROOT/etc/jarwis/"
          
          chmod 755 "$PKG_ROOT/usr/bin/jarwis-agent"
          
      - name: Build DEB package
        run: |
          chmod +x installer/linux/postinstall.sh || true
          chmod +x installer/linux/preremove.sh || true
          chmod +x installer/linux/postremove.sh || true
          
          fpm -s dir -t deb \
            --name "jarwis-agent" \
            --version "${{ env.VERSION }}" \
            --architecture "amd64" \
            --maintainer "Jarwis Security <support@jarwis.io>" \
            --vendor "Jarwis Security" \
            --description "Jarwis Security Testing Agent - Lightweight agent for security testing" \
            --url "https://jarwis.io" \
            --license "Proprietary" \
            --depends "libc6" \
            --config-files "/etc/jarwis/config.yaml" \
            --after-install "installer/linux/postinstall.sh" \
            --before-remove "installer/linux/preremove.sh" \
            --after-remove "installer/linux/postremove.sh" \
            -C "dist/linux/pkg-root" \
            --package "dist/linux/jarwis-agent_${{ env.VERSION }}_amd64.deb" \
            . || \
          fpm -s dir -t deb \
            --name "jarwis-agent" \
            --version "${{ env.VERSION }}" \
            --architecture "amd64" \
            --maintainer "Jarwis Security <support@jarwis.io>" \
            --description "Jarwis Security Testing Agent" \
            -C "dist/linux/pkg-root" \
            --package "dist/linux/jarwis-agent_${{ env.VERSION }}_amd64.deb" \
            .
            
      - name: Build RPM package
        run: |
          fpm -s dir -t rpm \
            --name "jarwis-agent" \
            --version "${{ env.VERSION }}" \
            --architecture "x86_64" \
            --maintainer "Jarwis Security <support@jarwis.io>" \
            --vendor "Jarwis Security" \
            --description "Jarwis Security Testing Agent" \
            --url "https://jarwis.io" \
            --license "Proprietary" \
            --depends "glibc" \
            --config-files "/etc/jarwis/config.yaml" \
            -C "dist/linux/pkg-root" \
            --package "dist/linux/jarwis-agent-${{ env.VERSION }}-1.x86_64.rpm" \
            . || true
            
      - name: Create tarball
        run: |
          tar -czf "dist/linux/jarwis-agent-${{ env.VERSION }}-linux-x86_64.tar.gz" \
            -C "dist/linux/pkg-root" \
            .
            
      - name: Upload Linux artifacts
        uses: actions/upload-artifact@v4
        with:
          name: linux-installer
          path: |
            dist/linux/jarwis-agent_*_amd64.deb
            dist/linux/jarwis-agent-*-1.x86_64.rpm
            dist/linux/jarwis-agent-*-linux-x86_64.tar.gz
          retention-days: 30
          if-no-files-found: error

  # ===========================================================================
  # Create Release
  # ===========================================================================
  release:
    name: Create Release
    needs: [build-windows, build-macos-intel, build-macos-arm64, build-linux]
    runs-on: ubuntu-latest
    # Only run if tag AND all builds succeeded
    if: ${{ startsWith(github.ref, 'refs/tags/v') && needs.build-windows.result == 'success' && needs.build-macos-intel.result == 'success' && needs.build-macos-arm64.result == 'success' && needs.build-linux.result == 'success' }}
    permissions:
      contents: write

    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Verify artifacts exist
        run: |
          echo "=== Artifact Structure ==="
          find artifacts -type f
          echo ""
          echo "=== Verifying required files ==="
          
          # Windows - check executables exist
          if ! ls artifacts/windows-installer/*.exe 1>/dev/null 2>&1; then
            echo "ERROR: Windows executables missing"
            exit 1
          fi
          echo "✅ Windows executables found"
          
          # macOS Intel - check PKG exists
          if ! ls artifacts/macos-intel-installer/*.pkg 1>/dev/null 2>&1; then
            echo "ERROR: macOS Intel PKG missing"
            exit 1
          fi
          echo "✅ macOS Intel PKG found"
          
          # macOS ARM64 - check PKG exists
          if ! ls artifacts/macos-arm64-installer/*.pkg 1>/dev/null 2>&1; then
            echo "ERROR: macOS ARM64 PKG missing"
            exit 1
          fi
          echo "✅ macOS ARM64 PKG found"
          
          # Linux - check DEB exists
          if ! ls artifacts/linux-installer/*.deb 1>/dev/null 2>&1; then
            echo "ERROR: Linux DEB missing"
            exit 1
          fi
          echo "✅ Linux DEB found"
          
          echo ""
          echo "=== All required artifacts verified ==="

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          name: Jarwis Agent ${{ github.ref_name }}
          draft: false
          prerelease: false
          generate_release_notes: true
          fail_on_unmatched_files: true
          files: |
            artifacts/windows-installer/*
            artifacts/macos-intel-installer/*
            artifacts/macos-arm64-installer/*
            artifacts/linux-installer/*
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
