#!/bin/bash
# ===========================================================================
# Jarwis Agent - macOS Post-Install Script
# ===========================================================================
#
# Runs after the PKG installation completes.
# Creates necessary directories and loads the agent service.
#
# ===========================================================================

set -e

echo "Jarwis Agent: Running post-install..."

# Create all required directories
mkdir -p /usr/local/var/jarwis
mkdir -p /usr/local/var/jarwis/data
mkdir -p /usr/local/var/jarwis/logs
mkdir -p /usr/local/var/log
mkdir -p /usr/local/etc/jarwis

# Set permissions
chmod 755 /usr/local/bin/jarwis-agent 2>/dev/null || true
chmod 755 /usr/local/var/jarwis
chmod 755 /usr/local/var/jarwis/data
chmod 755 /usr/local/var/jarwis/logs

# Ensure LaunchDaemon plist has correct permissions
if [ -f /Library/LaunchDaemons/com.jarwis.agent.plist ]; then
    chmod 644 /Library/LaunchDaemons/com.jarwis.agent.plist
    chown root:wheel /Library/LaunchDaemons/com.jarwis.agent.plist
fi

# Create default config if not exists
if [ ! -f /usr/local/etc/jarwis/agent.conf ]; then
    cat > /usr/local/etc/jarwis/agent.conf << EOF
# Jarwis Agent Configuration
# 
# Edit this file or use: jarwis-agent --configure

SERVER_URL=wss://jarwis.io/ws/agent
ACTIVATION_KEY=
LOG_LEVEL=INFO
MITM_PORT=8082
EOF
fi

# Load the LaunchDaemon (but don't start yet - need activation)
launchctl load /Library/LaunchDaemons/com.jarwis.agent.plist 2>/dev/null || true

echo "Jarwis Agent: Installation complete!"
echo ""
echo "To activate the agent, run:"
echo "  sudo jarwis-agent --activate YOUR_ACTIVATION_KEY"
echo ""
echo "Or configure manually:"
echo "  sudo nano /usr/local/etc/jarwis/agent.conf"
echo "  sudo launchctl start com.jarwis.agent"

exit 0
